<!DOCTYPE html>
<html>
<head>
    <title>lbapiQuery</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"vbox",align:"stretch"},artefactTypes:[{ID:1,Name:"User Story",value:"HierarchicalRequirement"},{ID:2,Name:"Defect",value:"Defect"},{ID:3,Name:"Task",value:"Task"},{ID:4,Name:"Test Case",value:"TestCase"}],items:[{xtype:"panel",layout:"anchor",border:!0,fieldDefaults:{labelWidth:40},defaultType:"textfield",bodyPadding:5,items:[{xtype:"container",layout:"hbox",width:"100%",itemId:"selectorBox"},{fieldLabel:"Query",itemId:"queryField",anchor:"100%",width:700,height:200,xtype:"textarea",value:'{\n    "ObjectID": {$gt:0},\n    "__At": "current"\n}'},{fieldLabel:"Fields",itemId:"fieldsField",anchor:"100%",width:700,value:"ObjectID, _ValidFrom, _UnformattedID, Name"},{fieldLabel:"Sort",itemId:"sortField",anchor:"100%",width:700,value:"{'ObjectID' : -1, '_ValidFrom': 1}"},{fieldLabel:"Page Size",itemId:"pageSizeField",anchor:"100%",width:700,value:"10"}],buttons:[{xtype:"rallybutton",text:"Search",itemId:"searchButton"},{xtype:"rallybutton",text:"CSV",itemId:"csvButton"}]},{xtype:"panel",itemId:"gridHolder",layout:"fit",height:400}],_addItemSelector:function(e){var t=this;this.down("#selectorBox").add(Ext.create("Rally.ui.combobox.ArtifactSearchComboBox",{fieldLabel:"Top Level Item: ",itemId:"itemSelector",margin:10,storeConfig:{models:["portfolioitem/"+e.rawValue.toLowerCase()]},listeners:{select:function(e){t._updateQuerySetting("_ItemHierarchy",e.getRecord().get("ObjectID"))},scope:t}}))},_addTypePicker:function(){var e=this,t=Ext.create("Ext.data.Store",{fields:["ID","Name","value"],data:{records:this.artefactTypes},proxy:{type:"memory",reader:{type:"json",root:"records"}}});this.down("#selectorBox").add(Ext.create("Rally.ui.picker.MultiObjectPicker",{store:t,margin:10,matchFieldName:"Name",selectionKey:"ID",recordKey:"ID",fieldLabel:"Lower types",listeners:{collapse:function(t){var o=[];_.each(t.getValue(),function(e){o.push(e.get("value"))}),e._updateQuerySetting("_TypeHierarchy",{$in:o})}}}))},launch:function(){var e=this.down("#selectorBox"),t=this.down("#searchButton"),o=this.down("#csvButton"),a=this;e.add(Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",{margin:10,listeners:{ready:function(e){_.each(e.store.getRecords(),function(e){a.artefactTypes.push({ID:a.artefactTypes.length+1,Name:e.get("Name"),value:e.get("TypePath")})}),a._addTypePicker(),a.down("#itemSelector")&&a.down("#itemSelector").destroy(),a._addItemSelector(e)},select:function(e){a.down("#itemSelector")&&a.down("#itemSelector").destroy(),a._addItemSelector(e)}},scope:a})),t.on("click",this.searchClicked,this),o.on("click",this.csvClicked,this)},_updateQuerySetting:function(e,t){var o=Ext.JSON.decode(this.down("#queryField").value);void 0!==t?o[e]=t:delete o[e],this.down("#queryField").setValue(this._prettyPrintJSON(Ext.JSON.encode(o))),this.searchClicked()},_prettyPrintJSON:function(e){var t="",o=0,a=0;return _.each(e,function(e){if("{"===e)for(t+=e+"\n",o+=4,a=0;a<o;a++)t+=" ";else if("}"===e){for(t+="\n",o-=4,a=0;a<o;a++)t+=" ";t+=e}else if(","===e)for(t+=e+"\n",a=0;a<o;a++)t+=" ";else t+=e}),t},searchClicked:function(){var e=this.down("#queryField").getValue(),t=this.down("#fieldsField").getValue();t="true"===t||t.split(", "),console.log(t);var o=this.down("#sortField").getValue(),a=this.down("#pageSizeField").getValue(),r=parseInt(a,10);a=r||10;var i=Ext.bind(this.processSnapshots,this);this.doSearch(e,t,o,a,i)},exportGrid:function(e){if(Ext.isIE)this._ieToExcel(e);else{var t=this._getCSV(e);window.location="data:text/csv;charset=utf8,"+encodeURIComponent(t)}},_escapeForCSV:function(e){return e='"'+(e=e.replace(/"/g,""))+'"'},_getFieldText:function(e){return null===e||void 0===e?"":e._refObjectName&&!e.getMonth?e._refObjectName:e instanceof Date?Ext.Date.format(e,this.dateFormat):"number"==typeof e?""+e:e.match?e:""},_getFieldTextAndEscape:function(e){var t=this._getFieldText(e);return this._escapeForCSV(t)},_getCSV:function(e){var t=e.columns,o=e.store,a="",r=this;return Ext.each(t,function(e){!0!==e.hidden&&(a+=r._getFieldTextAndEscape(e.text)+",")}),a+="\r\n",o.each(function(e){var o=e.getData();Ext.each(t,function(e){if(!0!==e.hidden){var t=e.dataIndex,i=o[t];a+=r._getFieldTextAndEscape(i)+","}}),a+="\r\n"}),a},_ieGetGridData:function(e,t){var o=this,a=e.columns;Ext.each(a,function(e,o){!0!==e.hidden&&(console.log("header: ",e.text),t.cells(1,o+1).value=e.text)});var r=2;e.store.each(function(e){var i=e.getData();Ext.each(a,function(e,a){if(!0!==e.hidden){var s=e.dataIndex,n=i[s],l=o._getFieldText(n);t.cells(r,a+1).value=l}}),r++})},_ieToExcel:function(e){if(window.ActiveXObject){var t,o;try{o=(t=new ActiveXObject("Excel.Application")).Workbooks.Add()}catch(e){return void Ext.Msg.alert("Error",'For the export to work in IE, you have to enable a security setting called "Initialize and script ActiveX control not marked as safe" from Internet Options -> Security -> Custom level..."')}o.worksheets("Sheet1").activate();var a=o.activeSheet;t.visible=!0,this._ieGetGridData(e,a),a.columns.autofit()}},csvClicked:function(){var e=this.down("#queryField").getValue(),t=this.down("#fieldsField").getValue();t="true"===t||t.split(", ");var o=this.down("#sortField").getValue(),a=this.down("#pageSizeField").getValue(),r=parseInt(a,10);a=r||10;var i=Ext.bind(this.processSnapshotsCSV,this);this.doSearch(e,t,o,a,i),Ext.Msg.alert("Please be patient it will take sometime to download...")},createSortMap:function(e){var t=e.split(", "),o={};for(var a in t)if(t.hasOwnProperty(a))return o[a]=1,o},doSearch:function(e,t,o,a,r){var i="https://rally1.rallydev.com/analytics/v2.0/service/rally/workspace/"+this.context.getWorkspace().ObjectID+"/artifact/snapshot/query.js",s={find:e};t&&(s.fields=Ext.JSON.encode(t)),o&&(s.sort=o),a&&(s.pagesize=a),Ext.Ajax.cors=!0,console.log("About to do:",i,s),Ext.Ajax.request({url:i,method:"GET",params:s,withCredentials:!0,success:function(e){var t=e.responseText,o=Ext.JSON.decode(t);r(o.Results)},failure:function(e){var t={},o="";t=e.responseText?Ext.JSON.decode(e.responseText):{Errors:[e.statusText]},_.each(t.Errors,function(e){o+="<p>"+e+"</p>"}),Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,draggable:!0,closable:!0,width:600,title:"Error Msg:",items:{xtype:"component",html:o}})}})},processSnapshots:function(e){var t=this.getFieldsFromSnapshots(e),o=Ext.create("Ext.data.Store",{storeId:"snapshotStore",fields:t,data:{items:e},proxy:{type:"memory",reader:{type:"json",root:"items"}}}),a=this.createColumnsForFields(t),r=Ext.create("Ext.grid.Panel",{title:"Snapshots",store:o,columns:a,height:400}),i=this.down("#gridHolder");i.removeAll(!0),i.add(r)},processSnapshotsCSV:function(e){var t=this.getFieldsFromSnapshots(e),o=Ext.create("Ext.data.Store",{storeId:"snapshotStore",fields:t,data:{items:e},proxy:{type:"memory",reader:{type:"json",root:"items"}}}),a=this.createColumnsForFields(t),r=Ext.create("Ext.grid.Panel",{title:"Snapshots",store:o,columns:a,height:400}),i=this.down("#gridHolder");i.removeAll(!0),i.add(r),this.exportGrid(r)},getFieldsFromSnapshots:function(e){if(0===e.length)return[];var t=e[0],o=[];for(var a in t)t.hasOwnProperty(a)&&o.push(a);return o},createColumnsForFields:function(e){var t=[],o=0;for(o=0;e.length>o;++o){var a={header:e[o],dataIndex:e[o]};"Name"===e[o]&&(a.flex=1),t.push(a)}return t}});

            Rally.launchApp('CustomApp', {
                name:"lbapiQuery",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
